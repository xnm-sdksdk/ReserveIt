version: "5.0.0"

services:
  #Infrastructure
  # PostgresSQL DBs
  postgres-booking:
    image: postgres:15
    container_name: postgres_booking
    environment:
      POSTGRES_DB: ${BOOKING_DB}
      POSTGRES_USER: ${BOOKING_USER}
      POSTGRES_PASSWORD: ${BOOKING_PWD}
    ports:
      - "5435:5432"
    volumes:
      - booking-db:/var/lib/postgresql/data
  postgres-resource:
    image: postgres:15
    container_name: postgres_resource
    environment:
      POSTGRES_DB: ${RESOURCE_DB}
      POSTGRES_USER: ${RESOURCE_USER}
      POSTGRES_PASSWORD: ${RESOURCE_PWD}
    ports:
      - "5434:5432"
    volumes:
      - resource-db:/var/lib/postgresql/data
  postgres-audit:
    image: postgres:15
    container_name: postgres_audit
    environment:
      POSTGRES_DB: ${AUDIT_DB}
      POSTGRES_USER: ${AUDIT_USER}
      POSTGRES_PASSWORD: ${AUDIT_PWD}
    ports:
      - "5433:5432"
    volumes:
      - audit-db:/var/lib/postgresql/data
  # MongoDB
  mongo-user:
    image: mongo:6
    container_name: mongo_user
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${USER_DB}
      MONGO_INITDB_ROOT_PASSWORD: ${USER_PWD}
    ports:
      - "27017:27017"
    volumes:
      - mongo-user-db:/data/db
  mongo-notification:
    image: mongo:6
    container_name: mongo_notification
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${NOTIFICATION_DB}
      MONGO_INITDB_ROOT_PASSWORD: ${NOTIFICATION_PWD}
    ports:
      - "27018:27017"
    volumes:
      - mongo-notification-db:/data/db

  mongo-availability:
    image: mongo:6
    container_name: mongo_availability
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${AVAILABILITY_DB}
      MONGO_INITDB_ROOT_PASSWORD: ${AVAILABILITY_PWD}
    ports:
      - "27019:27017"
    volumes:
      - mongo-availability-db:/data/db
  # Message Queue
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    ports:
      - "5672:5672"
      - "15672:15672"
  # Services
  # Quarkus
  resource-service:
    build:
      context: ./services/quarkus/resource-service
      dockerfile: src/main/docker/Dockerfile.jvm
    container_name: resource-service
    depends_on:
      - postgres-resource
    environment:
      QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://postgres-resource:5432/${RESOURCE_DB}
      QUARKUS_DATASOURCE_USERNAME: ${RESOURCE_USER}
      QUARKUS_DATASOURCE_PASSWORD: ${RESOURCE_PWD}
    ports:
      - "${RESOURCES_SERVICE}:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/q/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
  booking-service:
    build:
      context: ./services/quarkus/booking-service
      dockerfile: src/main/docker/Dockerfile.jvm
    container_name: booking-service
    depends_on:
      - postgres-booking
      - rabbitmq
    environment:
      QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://postgres-booking:5432/${BOOKING_DB}
      QUARKUS_DATASOURCE_USERNAME: ${BOOKING_USER}
      QUARKUS_DATASOURCE_PASSWORD: ${BOOKING_PWD}
    ports:
      - "${BOOKING_SERVICE}:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/q/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  audit-service:
    build:
      context: ./services/quarkus/audit-service
      dockerfile: src/main/docker/Dockerfile.jvm
    container_name: audit-service
    depends_on:
      - postgres-audit
    environment:
      QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://postgres-audit:5432/${AUDIT_DB}
      QUARKUS_DATASOURCE_USERNAME: ${AUDIT_USER}
      QUARKUS_DATASOURCE_PASSWORD: ${AUDIT_PWD}
    ports:
      - "${AUDIT_SERVICE}:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/q/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # Node
  user-service:
    build: ./services/nodejs/user-service/src
    container_name: user-service
    depends_on:
      - mongo-user
    environment:
      USER_MONGO_URL: mongodb://${USER_DB}:${USER_PWD}@mongo-user:27017
    ports:
      - "${USER_SERVICE}:3000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
  availability-service:
    build: ./services/nodejs/availability-service/src
    container_name: availability-service
    depends_on:
      - mongo-availability
      - rabbitmq
    environment:
      AVAILABILITY_MONGO_URL: mongodb://${AVAILABILITY_DB}:${AVAILABILITY_PWD}@mongo-availability:27017
      RABBITMQ_HOST: rabbitmq
    ports:
      - "${AVAILABILITY_SERVICE}:3000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
  notification-service:
    build: ./services/nodejs/notification-service/src
    container_name: notification-service
    depends_on:
      - mongo-notification
      - rabbitmq
    environment:
      NOTIFICATION_MONGO_URL: mongodb://${NOTIFICATION_DB}:${NOTIFICATION_PWD}@mongo-notification:27017
      RABBITMQ_HOST: rabbitmq
    ports:
      - "${NOTIFICATION_SERVICE}:3000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # Gateway
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    depends_on:
      - resource-service
      - availability-service
      - notification-service
      - audit-service
      - user-service
      - booking-service
    ports:
      - "8080:80"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

volumes:
  booking-db:
  resource-db:
  audit-db:
  mongo-user-db:
  mongo-notification-db:
  mongo-availability-db:
